<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
<script src="/js/game-connector.js"></script>

<script>
    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–º–µ–Ω—ã —Ö–æ–¥–∞ (—á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º)
    let lastActivePlayer = "";

    document.addEventListener("DOMContentLoaded", () => {
        
        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ –Ω–∞—à –æ–±—â–∏–π –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä
        GameApp.start(() => {
            console.log("–ò–≥—Ä–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É");
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
            GameApp.connection.invoke("InitGameView", GameApp.roomCode);
        });

        // 2. –°–ª—É—à–∞—Ç–µ–ª—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–æ–ª–∞
        GameApp.connection.on("UpdateTable", (data) => {
            renderGame(data);
        });

        // 3. –°–ª—É—à–∞—Ç–µ–ª—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã (–µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –ø–æ–±–µ–¥–∏–ª)
        GameApp.connection.on("GameOver", (winnerName) => {
            alert("üéâ –°–ª–∞–≤–Ω—ã–π –¥–µ–Ω—å! –ü–æ—Å–µ–ª–µ–Ω–∏–µ " + winnerName + " –ø—Ä–æ—Ü–≤–µ—Ç–∞–µ—Ç! –ù–∞–±—Ä–∞–Ω–æ 100 –º–æ–Ω–µ—Ç!");
            window.location.href = "/";
        });
    });

    function renderGame(data) {
        const myName = GameApp.userName;
        const currentPlayerName = data.currentPlayer;
        const isMyTurn = (myName === currentPlayerName);
        const activeColorStr = data.activeColor.toLowerCase();

        // --- –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –•–û–î–ï ---
        if (isMyTurn && lastActivePlayer !== myName) {
            showTurnAlert("–í–ê–® –•–û–î, –ü–û–°–ï–õ–ï–ù–ï–¶!");
        }
        lastActivePlayer = currentPlayerName;

        // --- 1. –°–ü–ò–°–û–ö –ò–ì–†–û–ö–û–í ---
        const playersDiv = document.getElementById("playersList");
        playersDiv.innerHTML = data.players.map(p => {
            const isThisPlayerTurn = p.name === currentPlayerName;
            const isMe = p.name === myName;
            return `
            <div class="player-pill ${isThisPlayerTurn ? 'active-glow' : ''}">
                ${p.name} ${isMe ? '<strong>(–í—ã)</strong>' : ''}: 
                <strong>${p.coins}üí∞</strong>
            </div>`;
        }).join('');

        // --- 2. –ò–ù–î–ò–ö–ê–¢–û–† –§–ê–ó–´ ---
        const colorBox = document.getElementById("currentPhaseColor");
        colorBox.className = "color-indicator " + activeColorStr;

        // --- 3. –†–´–ù–û–ö –ö–ê–†–¢ ---
        const marketDiv = document.getElementById("marketCards");
        marketDiv.innerHTML = data.market.map(card => `
            <div class="card-item ${isMyTurn ? 'clickable' : 'disabled'}" 
                 onclick="buyCard(${card.id}, ${isMyTurn})">
                <div class="card-header ${card.color.toLowerCase()}">${card.name}</div>
                <div class="card-body">
                    <div style="font-size: 2.5rem">${card.icon}</div>
                    <div class="reward-text">–î–æ—Ö–æ–¥: ${card.reward}üí∞</div>
                </div>
                <div class="card-footer">–¶–µ–Ω–∞: ${card.cost}</div>
            </div>
        `).join('');

        // --- 4. –ò–ù–í–ï–ù–¢–ê–†–¨ –ò –ú–û–ù–ï–¢–´ ---
        const me = data.players.find(p => p.name === myName);
        if (me) {
            document.getElementById("myCoins").innerText = me.coins;
            
            const inventoryDiv = document.getElementById("myInventory");
            inventoryDiv.innerHTML = me.inventory.map(c => {
                const canActivate = (c.color.toLowerCase() === activeColorStr && isMyTurn && !c.isUsed);
                const usedClass = c.isUsed ? "card-used" : "";
                
                return `
                <div class="card-mini-container">
                    <div class="card-mini-inner">
                        <!-- –õ–∏—Ü–æ –∫–∞—Ä—Ç—ã -->
                        <div class="card-front ${c.color.toLowerCase()} ${canActivate ? 'active-card-glow' : ''} ${usedClass}" 
                             onclick="useCard(${c.id}, ${canActivate})">
                            <span style="font-size: 1.5rem">${c.icon}</span>
                        </div>
                        <!-- –†—É–±–∞—à–∫–∞ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º (Flip effect) -->
                        <div class="card-back">
                            <div class="card-desc">
                                <strong>${c.name}</strong><br>
                                <small>${c.description || '–ü—Ä–∏–Ω–æ—Å–∏—Ç –∑–æ–ª–æ—Ç–æ –≤ —Å–≤–æ—é —Ñ–∞–∑—É'}</small>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
    }

    // --- –§–£–ù–ö–¶–ò–ò –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø ---

    function buyCard(cardId, canClick) {
        if (!canClick) return;
        GameApp.connection.invoke("PlayerClickCard", GameApp.roomCode, cardId)
            .catch(err => console.error(err));
    }

    function useCard(cardId, canActivate) {
        if (!canActivate) return;
        GameApp.connection.invoke("ActivateCard", GameApp.roomCode, cardId)
            .catch(err => console.error(err));
    }

    function finishTurn() {
        GameApp.connection.invoke("EndTurn", GameApp.roomCode)
            .catch(err => console.error(err));
    }

    function showTurnAlert(text) {
        const alertBox = document.getElementById("turn-alert");
        if(!alertBox) return;
        alertBox.innerText = text;
        alertBox.style.display = "block";
        setTimeout(() => { 
            alertBox.style.display = "none"; 
        }, 2500);
    }
</script>

<div id="turn-alert"></div>
<div class="game-board">
    <!-- –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨: –ò–≥—Ä–æ–∫–∏ –∏ –¢–µ–∫—É—â–∏–π —Ü–≤–µ—Ç -->
    <div class="top-bar">
        <div class="active-event">
            <span>–ê–∫—Ç–∏–≤–Ω–∞—è —Ñ–∞–∑–∞:</span>
            <div id="currentPhaseColor" class="color-indicator blue"></div>
        </div>
        
        <div class="players-status" id="playersList">
            <!-- –°—é–¥–∞ SignalR –ø–æ–¥—Å—Ç–∞–≤–∏—Ç –∏–≥—Ä–æ–∫–æ–≤ –∏ –∏—Ö –º–æ–Ω–µ—Ç—ã -->
            <div class="player-pill active">–ò–≥—Ä–æ–∫ 1: 15üí∞</div>
            <div class="player-pill">–ò–≥—Ä–æ–∫ 2: 10üí∞</div>
        </div>
    </div>

    <!-- –†–´–ù–û–ö: –ö–æ–ª–æ–¥–∞ + 5 –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–∞—Ä—Ç -->
    <div class="market-zone">
        <div class="deck-stack">
            <div class="card-back">üé¥<br>–ö–æ–ª–æ–¥–∞</div>
        </div>
        <div class="open-market" id="marketCards">
            <!-- 5 —è—á–µ–µ–∫ -->
            @for(int i=0; i<5; i++) {
                <div class="card-slot empty">–ü—É—Å—Ç–æ</div>
            }
        </div>
    </div>

    <!-- –†–£–ö–ê –ò–ì–†–û–ö–ê -->
    <div class="player-hand-section">
        <h3>–í–∞—à–∏ –≤–ª–∞–¥–µ–Ω–∏—è</h3>
        <div class="my-cards" id="myInventory">
            <!-- –ö–∞—Ä—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –∫—É–ø–ª–µ–Ω—ã -->
        </div>
        <div class="player-stats">
            <span class="coin-count">–í–∞—à–µ –∑–æ–ª–æ—Ç–æ: <strong id="myCoins">3</strong> üí∞</span>
            <button id="endTurnBtn" class="btn-stone" onclick="finishTurn()">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ö–æ–¥</button>
        </div>
    </div>
</div>

<style>

    .active-card-glow {
        cursor: pointer;
        animation: pulse 1.5s infinite;
        border: 2px solid #ffd700 !important;
        transform: scale(1.1);
    }

    @@keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
    }

    .btn-stone {
        background: #708090;
        color: white;
        padding: 10px 20px;
        border: 3px solid #2f4f4f;
        cursor: pointer;
        font-weight: bold;
    }
    .btn-stone:hover { background: #4f666a; }

    .card-used {
        opacity: 0.4;
        filter: grayscale(1);
        transform: scale(0.9);
        pointer-events: none; /* –ß—Ç–æ–±—ã –Ω–µ–ª—å–∑—è –±—ã–ª–æ –∫–ª–∏–∫–Ω—É—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è */
        transition: all 0.3s ease;
    }

    .game-board { background: #d2b48c; height: 100vh; padding: 20px; display: flex; flex-direction: column; gap: 30px; }
    
    /* –°—Ç–∏–ª–∏ –ø–∞–Ω–µ–ª–µ–π */
    .top-bar { display: flex; justify-content: space-between; background: rgba(255,255,255,0.3); padding: 15px; border-radius: 10px; }
    .color-indicator { width: 40px; height: 40px; border-radius: 50%; border: 3px solid #fff; display: inline-block; }
    .blue { background: #3498db; } .green { background: #2ecc71; } 
    .red { background: #e74c3c; } .purple { background: #9b59b6; }

    /* –†—ã–Ω–æ–∫ */
    .market-zone { display: flex; gap: 20px; justify-content: center; align-items: center; }
    .open-market { display: flex; gap: 15px; background: rgba(0,0,0,0.1); padding: 20px; border-radius: 15px; }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∞ */
    .card-item { 
        width: 120px; height: 180px; background: #fffdf0; border: 4px solid #8b4513; 
        border-radius: 10px; position: relative; cursor: pointer; transition: transform 0.2s;
    }
    .card-item:hover { transform: translateY(-10px); }
    .card-header { height: 30px; color: white; text-align: center; font-weight: bold; }
    
    .card-back { 
        width: 120px; height: 180px; background: #8b4513; color: white; 
        display: flex; align-items: center; justify-content: center; border-radius: 10px; 
    }

    .player-hand-section { margin-top: auto; background: #f5f5dc; padding: 20px; border-radius: 20px 20px 0 0; border-top: 5px solid #a0522d; }
    .my-cards { display: flex; gap: 10px; overflow-x: auto; }

    .player-pill.active-glow {
        border: 3px solid #ffd700;
        box-shadow: 0 0 15px #ffd700;
        transform: scale(1.1);
        background: #8b4513;
        color: white;
    }
    .card-item.clickable:hover { border-color: #ffd700; cursor: pointer; }
    .card-item.disabled { opacity: 0.7; cursor: not-allowed; }

    .active-glow {
        background: #8b4513 !important;
        color: #ffd700 !important;
        box-shadow: 0 0 20px #ffd700;
        border: 2px solid #ffd700;
    }
    .card-mini {
        width: 40px; height: 60px; border-radius: 5px;
        display: inline-flex; align-items: center; justify-content: center;
        margin-right: 5px; border: 1px solid #000; font-size: 1.5rem;
    }
    .card-item.disabled { filter: grayscale(0.5); opacity: 0.8; }
    .card-footer { background: rgba(0,0,0,0.1); font-weight: bold; border-radius: 0 0 10px 10px; }

    /* 1. –§–æ–Ω –∏–≥—Ä–æ–≤–æ–≥–æ —Å—Ç–æ–ª–∞ */
    .game-board {
        background: url('https://img.freepik.com') center/cover no-repeat;
        box-shadow: inset 0 0 200px rgba(0,0,0,0.5);
    }

    /* 2. –§–æ–Ω –ª–∏—Ü–µ–≤–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –∫–∞—Ä—Ç (–ø–µ—Ä–≥–∞–º–µ–Ω—Ç) */
    .card-item, .card-front {
        background: url('https://www.transparenttextures.com'), #fdf5e6;
        border: 3px solid #8b4513;
        border-radius: 8px;
    }

    /* 3. –≠—Ñ—Ñ–µ–∫—Ç –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞ –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è */
    .card-mini-container {
        perspective: 1000px;
        width: 60px; height: 90px;
    }

    .card-mini-inner {
        position: relative; width: 100%; height: 100%;
        transition: transform 0.6s; transform-style: preserve-3d;
    }

    .card-mini-container:hover .card-mini-inner {
        transform: rotateY(180deg);
    }

    .card-front, .card-back {
        position: absolute; width: 100%; height: 100%;
        backface-visibility: hidden; border-radius: 5px;
    }

    /* –†—É–±–∞—à–∫–∞ –∫–∞—Ä—Ç—ã –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ */
    .card-back {
        background: #5d2e0a url('https://www.transparenttextures.com');
        color: #ffd700; display: flex; align-items: center; justify-content: center;
        border: 2px solid #ffd700; transform: rotateY(180deg);
    }

    /* –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Ö–æ–¥–µ */
    #turn-alert {
        position: fixed; top: 20%; left: 50%; transform: translate(-50%, -50%);
        background: rgba(139, 69, 19, 0.9); color: white; padding: 20px 40px;
        border: 4px solid #ffd700; border-radius: 15px; z-index: 1000;
        font-size: 2rem; display: none; pointer-events: none;
    }



</style>