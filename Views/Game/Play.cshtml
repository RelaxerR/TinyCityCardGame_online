<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
<script src="/js/game-connector.js"></script>

<script>
    // –ö–∞–∫ —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≥–æ—Ç–æ–≤–∞
    document.addEventListener("DOMContentLoaded", () => {
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        GameApp.start(() => {
            // –ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ—Å–∏–º —Å–µ—Ä–≤–µ—Ä –¥–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã
            GameApp.connection.invoke("InitGameView", GameApp.roomCode);
        });

        // –°–ª—É—à–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        GameApp.connection.on("UpdateTable", (data) => {
            renderGame(data);
        });
    });

    function renderGame(data) {
        // 1. –ö—Ç–æ —è –∏ –º–æ–π –ª–∏ —Å–µ–π—á–∞—Å —Ö–æ–¥?
        const myName = GameApp.userName;
        const currentPlayerName = data.currentPlayer;
        const isMyTurn = (myName === currentPlayerName);

        console.log(`–°–µ–π—á–∞—Å —Ö–æ–¥–∏—Ç: ${currentPlayerName}. –Ø: ${myName}. –ú–æ–π —Ö–æ–¥: ${isMyTurn}`);

        // 2. –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ü–≤–µ—Ç–∞
        const colorBox = document.getElementById("currentPhaseColor");
        colorBox.className = "color-indicator " + data.activeColor.toLowerCase();

        // 3. –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
        const playersDiv = document.getElementById("playersList");
        playersDiv.innerHTML = data.players.map(p => {
            const isThisPlayerTurn = p.name === currentPlayerName;
            return `
            <div class="player-pill ${isThisPlayerTurn ? 'active-glow' : ''}">
                ${p.name}: <strong>${p.coins}üí∞</strong>
            </div>`;
        }).join('');

        // 4. –†–´–ù–û–ö (–ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å)
        const marketDiv = document.getElementById("marketCards");
        marketDiv.innerHTML = data.market.map(card => `
        <div class="card-item ${isMyTurn ? 'clickable' : 'disabled'}" 
             onclick="sendClick(${card.id}, ${isMyTurn})">
            <div class="card-header ${card.color.toLowerCase()}">${card.name}</div>
            <div class="card-body">
                <div style="font-size: 2.5rem">${card.icon}</div>
                <div class="reward-text">–î–æ—Ö–æ–¥: ${card.reward}üí∞</div>
            </div>
            <div class="card-footer">–¶–µ–Ω–∞: ${card.cost}</div>
        </div>
    `).join('');

        // 5. –ú–æ–∏ –º–æ–Ω–µ—Ç—ã –≤–Ω–∏–∑—É
        const me = data.players.find(p => p.name === myName);
        if (me) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Å—á–µ—Ç—á–∏–∫ –º–æ–Ω–µ—Ç (—É–±–µ–¥–∏—Å—å, —á—Ç–æ id="myCoins" –µ—Å—Ç—å –≤ HTML)
            const myCoinsElement = document.getElementById("myCoins");
            if (myCoinsElement) myCoinsElement.innerText = me.coins;

            const inventoryDiv = document.getElementById("myInventory");
            const activeColorStr = data.activeColor.toLowerCase(); // –ë–µ—Ä–µ–º —Ç–µ–∫—É—â–∏–π —Ü–≤–µ—Ç —Ñ–∞–∑—ã

            inventoryDiv.innerHTML = me.inventory.map(c => {
                // –£—Å–ª–æ–≤–∏–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏: —Å–æ–≤–ø–∞–ª —Ü–≤–µ—Ç, –º–æ–π —Ö–æ–¥ –∏ –∫–∞—Ä—Ç–∞ –ï–©–ï –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞
                const canActivate = (c.color.toLowerCase() === activeColorStr && isMyTurn && !c.isUsed);

                // –ö–ª–∞—Å—Å –¥–ª—è "—Å–µ—Ä–æ–π" –∫–∞—Ä—Ç—ã, –µ—Å–ª–∏ –æ–Ω–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞
                const usedClass = c.isUsed ? "card-used" : "";

                return `
        <div class="card-mini ${c.color.toLowerCase()} ${canActivate ? 'active-card-glow' : ''} ${usedClass}" 
             onclick="useCard(${c.id}, ${canActivate})" 
             title="${c.name} (–î–∞–µ—Ç ${c.reward}üí∞)">
            ${c.icon}
        </div>`;
            }).join('');
        }
    }

    function sendClick(cardId, canClick) {
        if (!canClick) {
            console.warn("–ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–∂–∞—Ç—å –Ω–µ –≤ —Å–≤–æ–π —Ö–æ–¥");
            return;
        }
        console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ:", cardId);
        GameApp.connection.invoke("PlayerClickCard", GameApp.roomCode, cardId)
            .catch(err => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ:", err));
    }

    function useCard(cardId, canActivate) {
        if (!canActivate) return;
        GameApp.connection.invoke("ActivateCard", GameApp.roomCode, cardId);
    }

    function finishTurn() {
        GameApp.connection.invoke("EndTurn", GameApp.roomCode);
    }
</script>

<div class="game-board">
    <!-- –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨: –ò–≥—Ä–æ–∫–∏ –∏ –¢–µ–∫—É—â–∏–π —Ü–≤–µ—Ç -->
    <div class="top-bar">
        <div class="active-event">
            <span>–ê–∫—Ç–∏–≤–Ω–∞—è —Ñ–∞–∑–∞:</span>
            <div id="currentPhaseColor" class="color-indicator blue"></div>
        </div>
        
        <div class="players-status" id="playersList">
            <!-- –°—é–¥–∞ SignalR –ø–æ–¥—Å—Ç–∞–≤–∏—Ç –∏–≥—Ä–æ–∫–æ–≤ –∏ –∏—Ö –º–æ–Ω–µ—Ç—ã -->
            <div class="player-pill active">–ò–≥—Ä–æ–∫ 1: 15üí∞</div>
            <div class="player-pill">–ò–≥—Ä–æ–∫ 2: 10üí∞</div>
        </div>
    </div>

    <!-- –†–´–ù–û–ö: –ö–æ–ª–æ–¥–∞ + 5 –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–∞—Ä—Ç -->
    <div class="market-zone">
        <div class="deck-stack">
            <div class="card-back">üé¥<br>–ö–æ–ª–æ–¥–∞</div>
        </div>
        <div class="open-market" id="marketCards">
            <!-- 5 —è—á–µ–µ–∫ -->
            @for(int i=0; i<5; i++) {
                <div class="card-slot empty">–ü—É—Å—Ç–æ</div>
            }
        </div>
    </div>

    <!-- –†–£–ö–ê –ò–ì–†–û–ö–ê -->
    <div class="player-hand-section">
        <h3>–í–∞—à–∏ –≤–ª–∞–¥–µ–Ω–∏—è</h3>
        <div class="my-cards" id="myInventory">
            <!-- –ö–∞—Ä—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –∫—É–ø–ª–µ–Ω—ã -->
        </div>
        <div class="player-stats">
            <span class="coin-count">–í–∞—à–µ –∑–æ–ª–æ—Ç–æ: <strong id="myCoins">3</strong> üí∞</span>
            <button id="endTurnBtn" class="btn-stone" onclick="finishTurn()">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ö–æ–¥</button>
        </div>
    </div>
</div>

<style>

    .active-card-glow {
        cursor: pointer;
        animation: pulse 1.5s infinite;
        border: 2px solid #ffd700 !important;
        transform: scale(1.1);
    }

    @@keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
    }

    .btn-stone {
        background: #708090;
        color: white;
        padding: 10px 20px;
        border: 3px solid #2f4f4f;
        cursor: pointer;
        font-weight: bold;
    }
    .btn-stone:hover { background: #4f666a; }

    .card-used {
        opacity: 0.4;
        filter: grayscale(1);
        transform: scale(0.9);
        pointer-events: none; /* –ß—Ç–æ–±—ã –Ω–µ–ª—å–∑—è –±—ã–ª–æ –∫–ª–∏–∫–Ω—É—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è */
        transition: all 0.3s ease;
    }

    .game-board { background: #d2b48c; height: 100vh; padding: 20px; display: flex; flex-direction: column; gap: 30px; }
    
    /* –°—Ç–∏–ª–∏ –ø–∞–Ω–µ–ª–µ–π */
    .top-bar { display: flex; justify-content: space-between; background: rgba(255,255,255,0.3); padding: 15px; border-radius: 10px; }
    .color-indicator { width: 40px; height: 40px; border-radius: 50%; border: 3px solid #fff; display: inline-block; }
    .blue { background: #3498db; } .green { background: #2ecc71; } 
    .red { background: #e74c3c; } .purple { background: #9b59b6; }

    /* –†—ã–Ω–æ–∫ */
    .market-zone { display: flex; gap: 20px; justify-content: center; align-items: center; }
    .open-market { display: flex; gap: 15px; background: rgba(0,0,0,0.1); padding: 20px; border-radius: 15px; }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∞ */
    .card-item { 
        width: 120px; height: 180px; background: #fffdf0; border: 4px solid #8b4513; 
        border-radius: 10px; position: relative; cursor: pointer; transition: transform 0.2s;
    }
    .card-item:hover { transform: translateY(-10px); }
    .card-header { height: 30px; color: white; text-align: center; font-weight: bold; }
    
    .card-back { 
        width: 120px; height: 180px; background: #8b4513; color: white; 
        display: flex; align-items: center; justify-content: center; border-radius: 10px; 
    }

    .player-hand-section { margin-top: auto; background: #f5f5dc; padding: 20px; border-radius: 20px 20px 0 0; border-top: 5px solid #a0522d; }
    .my-cards { display: flex; gap: 10px; overflow-x: auto; }

    .player-pill.active-glow {
        border: 3px solid #ffd700;
        box-shadow: 0 0 15px #ffd700;
        transform: scale(1.1);
        background: #8b4513;
        color: white;
    }
    .card-item.clickable:hover { border-color: #ffd700; cursor: pointer; }
    .card-item.disabled { opacity: 0.7; cursor: not-allowed; }

    .active-glow {
        background: #8b4513 !important;
        color: #ffd700 !important;
        box-shadow: 0 0 20px #ffd700;
        border: 2px solid #ffd700;
    }
    .card-mini {
        width: 40px; height: 60px; border-radius: 5px;
        display: inline-flex; align-items: center; justify-content: center;
        margin-right: 5px; border: 1px solid #000; font-size: 1.5rem;
    }
    .card-item.disabled { filter: grayscale(0.5); opacity: 0.8; }
    .card-footer { background: rgba(0,0,0,0.1); font-weight: bold; border-radius: 0 0 10px 10px; }


</style>