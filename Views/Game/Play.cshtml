<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
<script src="/js/game-connector.js"></script>

<script>
    let lastActivePlayer = "";
    let previousMarketCount = 0;

    document.addEventListener("DOMContentLoaded", () => {
        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –æ–±—â–∏–π –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä
        GameApp.start(() => {
            console.log("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã...");
            GameApp.connection.invoke("InitGameView", GameApp.roomCode);
        });

        // 2. –°–ª—É—à–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å—Ç–æ–ª–∞
        GameApp.connection.on("UpdateTable", (data) => {
            renderGame(data);
        });

        // 3. –°–ª—É—à–∞—Ç–µ–ª—å —Ñ–∏–Ω–∞–ª–∞
        GameApp.connection.on("GameOver", (winnerName) => {
            showTurnAlert("üéâ –ü–û–ë–ï–î–ê! " + winnerName.toUpperCase() + " –ü–†–ê–í–ò–¢ –≠–¢–ò–ú–ò –ó–ï–ú–õ–Ø–ú–ò!");
            setTimeout(() => { window.location.href = "/"; }, 5000);
        });
    });

    function renderGame(data) {
        const myName = GameApp.userName;
        const currentPlayerName = data.currentPlayer;
        const isMyTurn = (myName === currentPlayerName);
        const activeColorStr = data.activeColor.toLowerCase();
        const myData = data.players.find(p => p.name === myName);

        // --- –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –•–û–î–ï ---
        if (isMyTurn && lastActivePlayer !== myName) {
            showTurnAlert("–í–ê–® –•–û–î, –ü–û–°–ï–õ–ï–ù–ï–¶!");
        }
        lastActivePlayer = currentPlayerName;

        // --- –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –†–ê–£–ù–î–ï ---
        const roundElem = document.getElementById("roundNum");
        if(roundElem) roundElem.innerText = data.roundNumber || 1;

        // --- –°–ü–ò–°–û–ö –ò–ì–†–û–ö–û–í ---
        const playersDiv = document.getElementById("playersList");
        playersDiv.innerHTML = data.players.map(p => {
            const isTurn = p.name === currentPlayerName;
            return `
            <div class="player-pill ${isTurn ? 'active-glow' : ''}">
                ${p.name} ${p.name === myName ? '<strong>(–í—ã)</strong>' : ''}: 
                <strong>${p.coins}üí∞</strong>
            </div>`;
        }).join('');

        // --- –ò–ù–î–ò–ö–ê–¢–û–† –§–ê–ó–´ ---
        const colorBox = document.getElementById("currentPhaseColor");
        colorBox.className = "color-indicator " + activeColorStr;

        // --- –†–´–ù–û–ö (–° –∞–Ω–∏–º–∞—Ü–∏–µ–π –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è) ---
        const marketDiv = document.getElementById("marketCards");
        const isReplenishing = data.market.length > previousMarketCount;

        marketDiv.innerHTML = data.market.map((card, index) => {
            // –£—Å–ª–æ–≤–∏–µ –ø–æ–∫—É–ø–∫–∏: –º–æ–π —Ö–æ–¥, –ï–©–ï –ù–ï –ü–û–ö–£–ü–ê–õ, —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥
            const canAfford = isMyTurn && !myData.hasBoughtThisTurn && myData.coins >= card.cost;
            // –ê–Ω–∏–º–∞—Ü–∏—è –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–º –∫–∞—Ä—Ç–∞–º –≤ –∫–æ–Ω—Ü–µ –∫—Ä—É–≥–∞
            const animClass = (isReplenishing && index >= previousMarketCount) ? 'market-card-anim' : '';
            
            return `
            <div class="card-item ${animClass} ${canAfford ? 'can-afford' : 'disabled'}" 
                 onclick="buyCard(${card.id}, ${canAfford})">
                <div class="card-header ${card.color.toLowerCase()}">${card.name}</div>
                <div class="card-body">
                    <div style="font-size: 2rem">${card.icon}</div>
                    <div style="font-size: 0.8rem">–î–æ—Ö–æ–¥: ${card.reward}üí∞</div>
                </div>
                <div class="card-footer">–¶–µ–Ω–∞: ${card.cost}üí∞</div>
            </div>`;
        }).join('');
        
        previousMarketCount = data.market.length;

        // --- –ò–ù–í–ï–ù–¢–ê–†–¨ (–ö–∞—Ä—Ç—ã —Å Flip-—ç—Ñ—Ñ–µ–∫—Ç–æ–º) ---
        if (myData) {
            document.getElementById("myCoins").innerText = myData.coins;
            const inventoryDiv = document.getElementById("myInventory");

            // –í–ê–ñ–ù–û: —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ü–≤–µ—Ç ‚Äî —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            const serverActiveColor = String(data.activeColor).toLowerCase();

            inventoryDiv.innerHTML = myData.inventory.map(c => {
                const cardColor = String(c.color).toLowerCase();
                const serverActiveColor = String(data.activeColor).toLowerCase();

                const colorMatches = (cardColor === serverActiveColor);
                const canActivate = colorMatches && isMyTurn && !c.isUsed;

                const usedClass = c.isUsed ? "card-used" : "";
                const glowClass = canActivate ? "active-card-glow" : "";

                return `
                    <div class="card-mini-container ${canActivate ? 'clickable-card' : ''}" 
                         onclick="useCard(${c.id}, ${canActivate})">
                        <div class="card-mini-inner">
                            <!-- –õ–∏—Ü–æ –∫–∞—Ä—Ç—ã -->
                            <div class="card-front ${cardColor} ${glowClass} ${usedClass}">
                                 <div style="font-size: 2rem">${c.icon}</div>
                                 <div style="font-size: 0.7rem">${c.name}</div>
                            </div>
                            <!-- –†—É–±–∞—à–∫–∞ -->
                            <div class="card-back">
                                <strong>${c.name}</strong>
                                <p style="font-size: 10px">${c.description || '–†–µ—Å—É—Ä—Å'}</p>
                                <hr style="margin: 2px 0; border-color: #ffd700">
                                <span style="color: #ffd700; font-weight: bold;">+${c.reward}üí∞</span>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }

        // --- –ö–ù–û–ü–ö–ê –ó–ê–í–ï–†–®–ï–ù–ò–Ø –•–û–î–ê ---
        const endBtn = document.getElementById("endTurnBtn");
        if(endBtn) endBtn.disabled = !isMyTurn;
    }

    // --- –§–£–ù–ö–¶–ò–ò –í–´–ó–û–í–ê HUB ---

    function buyCard(cardId, canAfford) {
        if (!canAfford) return;
        GameApp.connection.invoke("PlayerClickCard", GameApp.roomCode, cardId)
            .catch(err => console.error("–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏:", err));
    }

    function useCard(cardId, canActivate) {
        console.log("–ü—ã—Ç–∞—é—Å—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É —Å ID:", cardId, "–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å:", canActivate);
        if (!canActivate) {
            console.warn("–ê–∫—Ç–∏–≤–∞—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–æ–º");
            return;
        }
        GameApp.connection.invoke("ActivateCard", GameApp.roomCode, cardId)
            .catch(err => console.error("–û—à–∏–±–∫–∞ SignalR:", err));
    }

    function finishTurn() {
        GameApp.connection.invoke("EndTurn", GameApp.roomCode)
            .catch(err => console.error("–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ö–æ–¥–∞:", err));
    }

    function showTurnAlert(text) {
        const alertBox = document.getElementById("turn-alert");
        if(!alertBox) return;
        alertBox.innerText = text;
        alertBox.style.display = "block";
        setTimeout(() => { alertBox.style.display = "none"; }, 3000);
    }
</script>

<div id="turn-alert"></div>
<div class="game-board">
    <!-- –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨: –ò–≥—Ä–æ–∫–∏ –∏ –¢–µ–∫—É—â–∏–π —Ü–≤–µ—Ç -->
    <div class="top-bar">
        <div class="active-event">
            <span>–ê–∫—Ç–∏–≤–Ω–∞—è —Ñ–∞–∑–∞:</span>
            <div id="currentPhaseColor" class="color-indicator blue"></div>
        </div>
        
        <div class="turn-info">
            <span class="round-badge">–†–ê–£–ù–î: <strong id="roundNum">1</strong></span>
        </div>
        
        <div class="players-status" id="playersList">
            <!-- –°—é–¥–∞ SignalR –ø–æ–¥—Å—Ç–∞–≤–∏—Ç –∏–≥—Ä–æ–∫–æ–≤ –∏ –∏—Ö –º–æ–Ω–µ—Ç—ã -->
            <div class="player-pill active">–ò–≥—Ä–æ–∫ 1: 15üí∞</div>
            <div class="player-pill">–ò–≥—Ä–æ–∫ 2: 10üí∞</div>
        </div>
    </div>

    <!-- –†–´–ù–û–ö: –ö–æ–ª–æ–¥–∞ + 5 –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–∞—Ä—Ç -->
    <div class="market-zone">
        <div class="deck-stack">
            <div class="card-back-v">
                <div class="deck-title">–ö–û–õ–û–î–ê</div>
                <div class="deck-count">???</div>
            </div>
        </div>
        <div class="open-market" id="marketCards">
            <!-- –°—é–¥–∞ –≤–ª–µ—Ç–∞—é—Ç –∫–∞—Ä—Ç—ã -->
        </div>
    </div>

    <!-- –†–£–ö–ê –ò–ì–†–û–ö–ê -->
    <div class="player-hand-section">
        <h3>–í–∞—à–∏ –≤–ª–∞–¥–µ–Ω–∏—è</h3>
        <div class="my-cards" id="myInventory">
            <!-- –ö–∞—Ä—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –∫—É–ø–ª–µ–Ω—ã -->
        </div>
        <div class="player-stats">
            <span class="coin-count">–í–∞—à–µ –∑–æ–ª–æ—Ç–æ: <strong id="myCoins">3</strong> üí∞</span>
            <button id="endTurnBtn" class="btn-stone" onclick="finishTurn()">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ö–æ–¥</button>
        </div>
    </div>
</div>

<style>
    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –∫–∞—Ä—Ç –Ω–∞ —Ä—ã–Ω–∫–µ */
    .market-card-anim {
        animation: slideInFromDeck 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @@keyframes slideInFromDeck {
        0% { transform: translate(-200px, -50px) rotate(-20deg); opacity: 0; }
        100% { transform: translate(0, 0) rotate(0); opacity: 1; }
    }

    .round-badge {
        background: #8b4513; color: #ffd700; padding: 5px 15px;
        border-radius: 20px; border: 2px solid #ffd700;
    }

    .card-back-v {
        width: 120px; height: 180px;
        background: #5d2e0a;
        border: 4px solid #8b4513;
        border-radius: 10px;
        display: flex; flex-direction: column;
        justify-content: center; align-items: center;
        color: #ffd700; font-weight: bold;
        box-shadow: 5px 5px 0 #3d1f07; /* –≠—Ñ—Ñ–µ–∫—Ç –ø–∞—á–∫–∏ */
    }
    
    .active-card-glow {
        cursor: pointer;
        animation: pulse 1.5s infinite;
        border: 2px solid #ffd700 !important;
        transform: scale(1.1);
    }

    @@keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
    }

    .btn-stone {
        background: #708090;
        color: white;
        padding: 10px 20px;
        border: 3px solid #2f4f4f;
        cursor: pointer;
        font-weight: bold;
    }
    .btn-stone:hover { background: #4f666a; }

    .card-used {
        opacity: 0.4;
        filter: grayscale(1);
        transform: scale(0.9);
        pointer-events: none; /* –ß—Ç–æ–±—ã –Ω–µ–ª—å–∑—è –±—ã–ª–æ –∫–ª–∏–∫–Ω—É—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è */
        transition: all 0.3s ease;
    }

    .game-board { background: #d2b48c; height: 100vh; padding: 20px; display: flex; flex-direction: column; gap: 30px; }
    
    /* –°—Ç–∏–ª–∏ –ø–∞–Ω–µ–ª–µ–π */
    .top-bar { display: flex; justify-content: space-between; background: rgba(255,255,255,0.3); padding: 15px; border-radius: 10px; }
    .color-indicator { width: 40px; height: 40px; border-radius: 50%; border: 3px solid #fff; display: inline-block; }
    .blue { background: #3498db; } .green { background: #2ecc71; } 
    .red { background: #e74c3c; } .purple { background: #9b59b6; }

    /* –†—ã–Ω–æ–∫ */
    .market-zone { display: flex; gap: 20px; justify-content: center; align-items: center; }
    .open-market { display: flex; gap: 15px; background: rgba(0,0,0,0.1); padding: 20px; border-radius: 15px; }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∞ */
    .card-item { 
        width: 120px; height: 180px; background: #fffdf0; border: 4px solid #8b4513; 
        border-radius: 10px; position: relative; cursor: pointer; transition: transform 0.2s;
    }
    .card-item:hover { transform: translateY(-10px); }
    .card-header { height: 30px; color: white; text-align: center; font-weight: bold; }
    
    .card-back { 
        width: 120px; height: 180px; background: #8b4513; color: white; 
        display: flex; align-items: center; justify-content: center; border-radius: 10px; 
    }

    .player-hand-section { margin-top: auto; background: #f5f5dc; padding: 20px; border-radius: 20px 20px 0 0; border-top: 5px solid #a0522d; }
    .my-cards { display: flex; gap: 10px; overflow-x: auto; }

    .player-pill.active-glow {
        border: 3px solid #ffd700;
        box-shadow: 0 0 15px #ffd700;
        transform: scale(1.1);
        background: #8b4513;
        color: white;
    }
    .card-item.clickable:hover { border-color: #ffd700; cursor: pointer; }
    .card-item.disabled { opacity: 0.7; cursor: not-allowed; }

    .active-glow {
        background: #8b4513 !important;
        color: #ffd700 !important;
        box-shadow: 0 0 20px #ffd700;
        border: 2px solid #ffd700;
    }
    .card-mini {
        width: 40px; height: 60px; border-radius: 5px;
        display: inline-flex; align-items: center; justify-content: center;
        margin-right: 5px; border: 1px solid #000; font-size: 1.5rem;
    }
    .card-item.disabled { filter: grayscale(0.5); opacity: 0.8; }
    .card-footer { background: rgba(0,0,0,0.1); font-weight: bold; border-radius: 0 0 10px 10px; }

    /* 1. –§–æ–Ω –∏–≥—Ä–æ–≤–æ–≥–æ —Å—Ç–æ–ª–∞ */
    .game-board {
        background: url('https://img.freepik.com') center/cover no-repeat;
        box-shadow: inset 0 0 200px rgba(0,0,0,0.5);
    }

    /* 2. –§–æ–Ω –ª–∏—Ü–µ–≤–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –∫–∞—Ä—Ç (–ø–µ—Ä–≥–∞–º–µ–Ω—Ç) */
    .card-item, .card-front {
        background: url('https://www.transparenttextures.com'), #fdf5e6;
        border: 3px solid #8b4513;
        border-radius: 8px;
    }

    /* 3. –≠—Ñ—Ñ–µ–∫—Ç –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞ –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è */
    .card-mini-container {
        perspective: 1000px;
        width: 60px; height: 90px;
    }

    .card-mini-inner {
        position: relative; width: 100%; height: 100%;
        transition: transform 0.6s; transform-style: preserve-3d;
    }

    .card-mini-container:hover .card-mini-inner {
        transform: rotateY(180deg);
    }

    .card-front, .card-back {
        position: absolute; width: 100%; height: 100%;
        backface-visibility: hidden; border-radius: 5px;
    }

    /* –†—É–±–∞—à–∫–∞ –∫–∞—Ä—Ç—ã –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ */
    .card-back {
        background: #5d2e0a url('https://www.transparenttextures.com');
        color: #ffd700; display: flex; align-items: center; justify-content: center;
        border: 2px solid #ffd700; transform: rotateY(180deg);
    }

    /* –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Ö–æ–¥–µ */
    #turn-alert {
        position: fixed; top: 20%; left: 50%; transform: translate(-50%, -50%);
        background: rgba(139, 69, 19, 0.9); color: white; padding: 20px 40px;
        border: 4px solid #ffd700; border-radius: 15px; z-index: 1000;
        font-size: 2rem; display: none; pointer-events: none;
    }

    /* –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å */
    .card-mini-container {
        perspective: 1000px;
        width: 100px; height: 140px; /* –ë—ã–ª–æ 60x90 */
        margin: 5px;
    }

    .card-back {
        background: #5d2e0a;
        color: #ffd700;
        padding: 8px;
        font-size: 11px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: center;
        border: 2px solid #ffd700;
        transform: rotateY(180deg);
    }

    /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –∫–∞—Ä—Ç */
    .card-item.can-afford {
        box-shadow: 0 0 15px #2ecc71;
        border-color: #2ecc71 !important;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∫–∞—Ä—Ç—ã */
    @@keyframes card-fly-in {
        0% { transform: scale(0) translateX(-200px); opacity: 0; }
        100% { transform: scale(1) translateX(0); opacity: 1; }
    }

    .new-card-anim {
        animation: card-fly-in 0.5s ease-out;
    }

    /* –ö–Ω–æ–ø–∫–∞ "–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ö–æ–¥" –∞–∫—Ç–∏–≤–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞ */
    .btn-stone:disabled {
        filter: grayscale(1);
        opacity: 0.5;
        cursor: not-allowed;
    }


</style>